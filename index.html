<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Pizza Dough Calculator</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html">Pizza Dough Calculator</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item active">
                <a class="nav-link" href="index.html">Calculator<span class="sr-only">(current)</span></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="favorites.html">Favorites<span class="sr-only">(current)</span></a>
              </li>
            </ul>
        </div>
        <form class="form-inline my-2 my-lg-0">
            <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle">Wake Lock is disabled</button>
        </form>
    </nav>
    <div class="container">
        <div class="row mt-3">
            <div class="col">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-sm">
                        <tr>
                            <td>Thickness Factor</td>
                            <td colspan=7>
                                <input type="number" class="form-control" placeholder="0" step="any" id="thicknessFactor">
                            </td>
                        </tr>
                        <tr>
                            <td>Shape</td>
                            <td colspan=7>
                                <div class="form-group">
                                    <select id="shape" class="form-control">
                                        <option selected>Round</option>
                                        <option>Rectangular</option>
                                    </select>
                                </div>
                                <div class="form-row" id="rectangular-form">
                                    <div class="form-group col-md-6">
                                        <label for="width">Width</label>
                                        <input type="number" step="any" class="form-control" placeholder="0" id="width">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="length">Length</label>
                                        <input type="number" step="any" class="form-control" placeholder="0" id="length">
                                    </div>
                                </div>
                                <div class="form-group" id="round-form">
                                    <label for="diameter">Diameter</label>
                                    <input type="number" class="form-control" placeholder="0" step="any" id="diameter">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Quantity</td>
                            <td colspan=7>
                                <input type="number" class="form-control" placeholder="0" step="any" id="quantity">
                            </td>
                        </tr>
                        <tr>
                            <th>&nbsp;</th>
                            <th class="col-xs-12">&nbsp;</th>
                            <th>grams</th>
                            <th>tsp</th>
                            <th>tbsp</th>
                        </tr>
                        <tr id="flour-row-0">
                            <td>Flour</td>
                            <td colspan=4>
                                <button class="btn btn-primary btn-sm" id="add-flour">Customize flour</button>
                                <button id="remove-flour" class="remove-flour btn btn-sm btn-secondary" style="display:none;">Remove flour</button>
                                <div id="multi-flour" style="display:none;">
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="width">Width</label>
                                            <input type="number" step="any" class="form-control" placeholder="0" id="width">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="length">Length</label>
                                            <input type="number" step="any" class="form-control" placeholder="0" id="length">
                                        </div>
                                    </div>
                                    <div class="form-group" id="diameter-row">
                                        <label for="diameter">Diameter</label>
                                        <input type="number" class="form-control" placeholder="0" step="any" id="diameter">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Water</td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="0" step="any" id="water">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </td>
                                <td id="water-gram"></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            <tr>
                                <td>
                                    Yeast
                                    <div class="form-group">
                                        <select id="yeast_type" class="form-control">
                                            <option selected>IDY</option>
                                            <option>ADY</option>
                                            <option>Cake</option>
                                        </select>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="0" step="any" id="yeast">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </td>
                                <td id="yeast-gram"></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            <tr>
                                <td>Salt</td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="0" step="any" id="salt">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </td>
                                <td id="salt-gram"></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            <tr>
                                <td>Oil</td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="0" step="any" id="oil">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </td>
                                <td id="oil-gram"></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            <tr>
                                <td>Sugar</td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="0" step="any" id="sugar">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </td>
                                <td id="sugar-gram"></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            <tr>
                                <td>Total (g)</td>
                                <td>&nbsp;</td>
                                <td colspan=6>
                                    <div id="total-gram"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>Per ball (g)</td>
                                <td>&nbsp;</td>
                                <td colspan=6>
                                    <div id="perball-gram"></div>
                                </td>
                            </tr>
                        </table>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        Image Upload
                    </div>
                    <div class="card-body">
                        <form id="imgur">
                            <input id="imgurUpload" type="file" class="imgur" accept="image/*" data-max-size="5000"/>
                            <div class="progress" id="upload-progress" style="display:none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div>
                            </div>
                        </form>
                        <p class="card-text" >
                            <img id="image-preview" class="img-fluid rounded mx-auto d-block" />
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        Sharing Options
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">URL</h5>
                        <p class="card-text" id="url"></p>
                        <h5 class="card-title">Table</h5>
                        <p class="card-text" id="table"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <script src="nosleep.min.js"></script>
    <script>
        var noSleep = new NoSleep();
        var wakeLockEnabled = false;
        var toggleEl = document.querySelector("#toggle");
        toggleEl.addEventListener('click', function() {
            if (!wakeLockEnabled) {
                noSleep.enable(); // keep the screen on!
                wakeLockEnabled = true;
                toggleEl.innerHTML = "Wake Lock is enabled";
                toggleEl.setAttribute("class", "btn btn-sm btn-secondary");
            } else {
                noSleep.disable(); // let the screen turn off.
                wakeLockEnabled = false;
                toggleEl.innerHTML = "Wake Lock is disabled";
                toggleEl.setAttribute("class", "btn btn-sm btn-outline-secondary");
            }
        }, false);
    </script>

    <script src="dough.js"></script>
    <script>
        $(function() {
            var flourRow = 0;
            var doughRequest2 = new DoughRequest().parseURL(window.location.href);

            $("#thicknessFactor").val(doughRequest2.getTf());
            $("#diameter").val(doughRequest2.getDiameter());
            $("#shape").val(doughRequest2.getShape());
            $("#length").val(doughRequest2.getLength());
            $("#width").val(doughRequest2.getWidth());
            $("#quantity").val(doughRequest2.getQuantity());
            $("#water").val(doughRequest2.getWater());
            $("#yeast_type").val(doughRequest2.getYeastType());
            $("#yeast").val(doughRequest2.getYeast());
            $("#salt").val(doughRequest2.getSalt());
            $("#sugar").val(doughRequest2.getSugar());
            $("#oil").val(doughRequest2.getOil());

            if(doughRequest2.getImage() != null) {
                $("#upload-progress").hide();
                $("#imgurUpload").hide();
                $("#image-preview").attr("src", doughRequest2.getImage());
            }

            flours = doughRequest2.getFlours();
            
            if(flours.length > 0) {
                for(flour=0; flour < flours.length; flour++) {
                    addFlour1(flours[flour].getName(), flours[flour].getAmount());
                }
            }

            switch($("#shape").val()) {
                case "Round":
                    $("#round-form").show();
                    $("#rectangular-form").hide();
                    break;
                case "Rectangular":
                    $("#round-form").hide();
                    $("#rectangular-form").show();
                    break;
                default:
                    break;
            };
            updateResults();

            $( "#thicknessFactor" ).change(function () {
                doughRequest2.setTf($("#thicknessFactor").val());
                updateResults();
            })

            $("#diameter").change(function () {
                doughRequest2.setDiameter($("#diameter").val());
                updateResults();
            });

            $("#shape").change(function () {
                doughRequest2.setShape($("#shape").val());
                updateResults();
            });

            $("#length").change(function () {
                doughRequest2.setLength($("#length").val());
                updateResults();
            });

            $("#width").change(function () {
                doughRequest2.setWidth($("#width").val());
                updateResults();
            });

            $("#quantity").change(function () {
                doughRequest2.setQuantity($("#quantity").val());
                updateResults();
            });

            $("#water").change(function () {
                doughRequest2.setWater($("#water").val());
                updateResults();
            });

            $("#yeast_type").change(function () {
                doughRequest2.setYeastType($("#yeast_type").val());
                updateResults();
            });

            $("#yeast").change(function () {
                doughRequest2.setYeast($("#yeast").val());
                updateResults();
            });

            $("#salt").change(function () {
                doughRequest2.setSalt($("#salt").val());
                updateResults();
            });

            $("#sugar").change(function () {
                doughRequest2.setSugar($("#sugar").val());
                updateResults();
            });

            $("#oil").change(function () {
                doughRequest2.setOil($("#oil").val());
                updateResults();
            });

            $("#add-flour").on("click", function() {
                addFlour1("", 0);
                doughRequest2.addFlour(new Flour("", 0));
                updateResults();
            });

            function addFlour1(name, amount) {
                $(`
                    <tr id="flour-row-${flourRow + 1}" class="flourRow">
                        <td>&nbsp;</td>
                        <td>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="flour${flourRow + 1}">Flour #${flourRow + 1}</label>
                                    <input type="text" class="form-control" placeholder="Flour" id="flour${flourRow + 1}" name="flour[]" value="${name}">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="flour${flourRow + 1}">Amount</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="0" step="any" id="flour${flourRow + 1}_amt" name="flour_amount[]" value="${amount}">
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td id="flour${flourRow + 1}-gram">&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                `).insertAfter("#flour-row-" + flourRow);
                flourRow++;
                $("button.remove-flour").show();
            };

            $(document).on("click", "button.remove-flour", function(){
                $("#flour-row-"+flourRow).remove();
                doughRequest2.removeFlour();
                console.log(doughRequest2.getFlours());
                flourRow--;
                if(flourRow == 0) {
                    $("button.remove-flour").hide();

                }
                updateResults();
            });

            $("#shape").change(function() {
                switch($(this).val()) {
                    case "Round":
                        $("#round-form").show();
                        $("#rectangular-form").hide();
                        break;
                    case "Rectangular":
                        $("#round-form").hide();
                        $("#rectangular-form").show();
                        break;
                    default:
                        break;
                };
            });

            $(document).on("change", 'input[name="flour[]"]', function() {
                var flours = [];                
                $('.flourRow').each( function() {
                    flours.push(
                        new Flour($(this).find('input[name="flour[]"]').first().val(), $(this).find('input[name="flour_amount[]"]').first().val())
                    );
                });
                doughRequest2.setFlours(flours);
                updateResults();
            });

            $(document).on("change", 'input[name="flour_amount[]"]', function() {
                var flours = [];
                $('.flourRow').each( function() {
                    
                    flours.push(
                        new Flour(
                            $(this).find('input[name="flour[]"]').first().val(),
                            $(this).find('input[name="flour_amount[]"]').first().val()
                        )
                    );
                });
                console.log(doughRequest2);
                doughRequest2.setFlours(flours);
                console.log(doughRequest2);

                updateResults();
            });

            function updateResults() {
                doughRequest2.calculate();
                if(flourRow == 0) {
                console.log(doughRequest2.doughResult.getFlourGram().toFixed(2));
                    $("#flour-gram").html(doughRequest2.doughResult.getFlourGram().toFixed(2));
                }
                else {
                    $("#flour-gram").html("");
                    flours = doughRequest2.getFlours();

                    for(f = 1; f < flourRow + 1; f++) {
                        if(flours[f-1] !== void 0) {
                            $("#flour"+f+"-gram").html(
                                
                               (doughRequest2.doughResult.getFlourGram() * doughRequest2.getFlours()[f-1].getAmount() / 100).toFixed(2)
                               
                            );
                            
                        } 
                        else {
                        }
                    }
                }

                $("#water-gram").html(doughRequest2.doughResult.getWaterGram().toFixed(2));
                $("#yeast-gram").html(doughRequest2.doughResult.getYeastGram().toFixed(2));
                $("#salt-gram").html(doughRequest2.doughResult.getSaltGram().toFixed(2));
                $("#oil-gram").html(doughRequest2.doughResult.getOilGram().toFixed(2));
                $("#sugar-gram").html(doughRequest2.doughResult.getSugarGram().toFixed(2));
                $("#total-gram").html(doughRequest2.doughResult.getTotalGram().toFixed(2));
                $("#perball-gram").html(doughRequest2.doughResult.getPerballGram().toFixed(2));

                $("#url").html(doughRequest2.getShareableURL(document.location.origin, document.location.pathname));
                $("#table").html(doughRequest2.doughResult.getHTMLTable());
            }

            $("#imgurUpload").change(function () {
                upload($(this)[0].files[0]);
            })

            function upload(file) {
                document.getElementById("imgurUpload").style.display = "none";
                document.getElementById("upload-progress").style.display = "";

                if (!file || !file.type.match(/image.*/)) return;

                document.body.className = "uploading";

                var fd = new FormData();
                fd.append("image", file);
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "https://api.imgur.com/3/image.json");
                xhr.onload = function() {
                    updateResults();
                    document.getElementById("upload-progress").style.display = "none";
                    document.getElementById("image-preview").src = JSON.parse(xhr.responseText).data.link;
                    doughRequest2.setImage(JSON.parse(xhr.responseText).data.link);
                    updateResults();

                }
                
                xhr.setRequestHeader('Authorization', 'Client-ID 8061f70841482dc'); 
                xhr.send(fd);
            }
        });
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133179201-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-133179201-1');
    </script>    
</body>