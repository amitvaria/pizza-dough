<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Pizza Dough Calculator</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html">Pizza Dough Calculator</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item active">
                <a class="nav-link" href="index.html">Calculator<span class="sr-only">(current)</span></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="favorites.html">Favorites<span class="sr-only">(current)</span></a>
              </li>
            </ul>
        </div>
        <form class="form-inline my-2 my-lg-0">
            <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle">Wake Lock is disabled</button>
        </form>
    </nav>
    <div class="container">
        <div class="row mt-3">
            <div class="col">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-sm">
                        <tr>
                            <td>Thickness Factor</td>
                            <td colspan=7>
                                <input type="number" class="form-control" placeholder="0" step="any" id="thicknessFactor">
                            </td>
                        </tr>
                        <tr>
                            <td>Shape</td>
                            <td colspan=7>
                                <div class="form-group">
                                    <select id="shape" class="form-control">
                                        <option selected>Round</option>
                                        <option>Rectangular</option>
                                    </select>
                                </div>
                                <div class="form-row" id="rectangular-row">
                                    <div class="form-group col-md-6">
                                        <label for="width">Width</label>
                                        <input type="number" step="any" class="form-control" placeholder="0" id="width">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="length">Length</label>
                                        <input type="number" step="any" class="form-control" placeholder="0" id="length">
                                    </div>
                                </div>
                                <div class="form-group" id="diameter-row">
                                    <label for="diameter">Diameter</label>
                                    <input type="number" class="form-control" placeholder="0" step="any" id="diameter">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Quantity</td>
                            <td colspan=7>
                                <input type="number" class="form-control" placeholder="0" step="any" id="quantity">
                            </td>
                        </tr>
                        <tr>
                            <th>&nbsp;</th>
                            <th class="col-xs-12">&nbsp;</th>
                            <th>grams</th>
                            <th>tsp</th>
                            <th>tbsp</th>
                        </tr>
                        <tr>
                            <td>Flour</td>
                            <td>
                                <button class="btn btn-primary btn-sm" id="add-flour">Customize flour</button>
                                <div id="multi-flour" style="display:none;">
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="flour1">Flour #1</label>
                                            <input type="text" class="form-control" placeholder="Flour" id="flour1">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="flour1">Amount</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" placeholder="0" step="any" id="flour1_amt">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="flour2">Flour #2</label>
                                            <input type="text" class="form-control" placeholder="Flour" id="flour2">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="flour2">Amount</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" placeholder="0" step="any" id="flour2_amt">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="flour3">Flour #3</label>
                                            <input type="text" class="form-control" placeholder="Flour" id="flour3">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="flour3">Amount</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" placeholder="0" step="any" id="flour3_amt">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning" role="alert" id="flour-error">Amount should add up to 100</div>
                                    <button class="btn btn-secondary btn-sm" id="clear-flour">Clear flour</button>
                                </div>
                            </td>
                            <td id="flour-gram"></td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Water</td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="0" step="any" id="water">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </td>
                            <td id="water-gram"></td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>
                                Yeast
                                <div class="form-group">
                                    <select id="yeast_type" class="form-control">
                                        <option selected>IDY</option>
                                        <option>ADY</option>
                                        <option>Cake</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="0" step="any" id="yeast">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </td>
                            <td id="yeast-gram"></td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Salt</td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="0" step="any" id="salt">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </td>
                            <td id="salt-gram"></td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Oil</td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="0" step="any" id="oil">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </td>
                            <td id="oil-gram"></td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Sugar</td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="0" step="any" id="sugar">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </td>
                            <td id="sugar-gram"></td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Total (g)</td>
                            <td>&nbsp;</td>
                            <td colspan=6>
                                <div id="total-gram"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>Per ball (g)</td>
                            <td>&nbsp;</td>
                            <td colspan=6>
                                <div id="perball-gram"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        Image Upload
                    </div>
                    <div class="card-body">
                        <form id="imgur">
                            <input id="imgurUpload" type="file" class="imgur" accept="image/*" data-max-size="5000" onchange="upload(this.files[0])"/>
                            <div class="progress" id="upload-progress" style="display:none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div>
                            </div>
                        </form>
                        <p class="card-text" >
                            <img id="image-preview" class="img-fluid rounded mx-auto d-block" />
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        Sharing Options
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">URL</h5>
                        <p class="card-text" id="url"></p>
                        <h5 class="card-title">Table</h5>
                        <p class="card-text" id="table"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <script src="nosleep.min.js"></script>
    <script>
        var noSleep = new NoSleep();
        var wakeLockEnabled = false;
        var toggleEl = document.querySelector("#toggle");
        toggleEl.addEventListener('click', function() {
            if (!wakeLockEnabled) {
                noSleep.enable(); // keep the screen on!
                wakeLockEnabled = true;
                toggleEl.innerHTML = "Wake Lock is enabled";
                toggleEl.setAttribute("class", "btn btn-sm btn-secondary");
            } else {
                noSleep.disable(); // let the screen turn off.
                wakeLockEnabled = false;
                toggleEl.innerHTML = "Wake Lock is disabled";
                toggleEl.setAttribute("class", "btn btn-sm btn-outline-secondary");
            }
        }, false);
    </script>

    <script src="dough.js"></script>
    <script>

        let tf = document.getElementById("thicknessFactor");
        let quantity = document.getElementById("quantity");
        let shape = document.getElementById("shape");
        let diameter = document.getElementById("diameter");
        let length = document.getElementById("length");
        let width = document.getElementById("width");
        let flour1 = document.getElementById("flour1");
        let flour1_amt = document.getElementById("flour1_amt");
        let flour2 = document.getElementById("flour2");
        let flour2_amt = document.getElementById("flour2_amt");
        let flour3 = document.getElementById("flour3");
        let flour3_amt = document.getElementById("flour3_amt");
        let flour_error = document.getElementById("flour-error");
        let water = document.getElementById("water");
        let yeast_type = document.getElementById("yeast_type");
        let yeast = document.getElementById("yeast");
        let salt = document.getElementById("salt");
        let oil = document.getElementById("oil");
        let sugar = document.getElementById("sugar");

        let rectangular_row = document.getElementById("rectangular-row");
        let diameter_row = document.getElementById("diameter-row");

        //Flour UI
        document.getElementById("add-flour").addEventListener("click", function(e) {
            document.getElementById("add-flour").style.display = "none"
            document.getElementById("multi-flour").style.display = null;
        }, false);

        document.getElementById("clear-flour").addEventListener("click", function(e) {
            document.getElementById("multi-flour").style.display = "none"
            document.getElementById("add-flour").style.display = null;
            flour1.value = flour1_amt.value = flour2.value = flour2_amt.value = flour3.value = flour3_amt.value = "";
            calc();
        }, false);

        document.addEventListener('input', calc);
        function calc() {
            //Calculate dough measurements
            doughResult = new DoughRequest().setTf(thicknessFactor.value)
                                      .setQuantity(quantity.value)
                                      .setShape(shape.value)
                                      .setDiameter(diameter.value)
                                      .setLength(length.value)
                                      .setWidth(width.value)
                                      .setWater(water.value)
                                      .setYeastType(yeast_type.value)
                                      .setYeast(yeast.value)
                                      .setSalt(salt.value)
                                      .setOil(oil.value)
                                      .setSugar(sugar.value)
                                      .setFlours([
                                        new Flour(flour1.value, flour1_amt.value),
                                        new Flour(flour2.value, flour2_amt.value),
                                        new Flour(flour3.value, flour3_amt.value)
                                      ])
                                      .setImage(document.getElementById("image-preview").src)
                                      .calculate();

            //Make the shareable URL
            url = doughResult.doughRequest.getShareableURL(top.location.origin.toString(), top.location.pathname.toString());
            document.getElementById("url").innerHTML = "<a href='" + url + "'>" + url + "</a>";

            //Make a shareable table
            document.getElementById("table").innerHTML = doughResult.getHTMLTable();

            //Update the main table
            document.getElementById("total-gram").innerHTML = doughResult.getTotalGram().toFixed(2);
            document.getElementById("perball-gram").innerHTML = doughResult.getPerballGram().toFixed(2);
            document.getElementById("flour-gram").innerHTML = doughResult.getFlourGram().toFixed(2);
            document.getElementById("water-gram").innerHTML = doughResult.getWaterGram().toFixed(2);
            document.getElementById("yeast-gram").innerHTML = doughResult.getYeastGram().toFixed(2);
            document.getElementById("salt-gram").innerHTML = doughResult.getSaltGram().toFixed(2);
            document.getElementById("oil-gram").innerHTML = doughResult.getOilGram().toFixed(2);
            document.getElementById("sugar-gram").innerHTML = doughResult.getSugarGram().toFixed(2);

            //Update UI
            switch(shape.value.toString()) {
              case "Round":
                rectangular_row.style.display = "none";
                diameter_row.style.display = null;
                break;
              case "Rectangular":
                rectangular_row.style.display = null;
                diameter_row.style.display = "none";
                break;
            }

            if(doughResult.doughRequest.isValidFlourAmount()) {
                flour_error.style.display = "none";                
            } else {
                flour_error.style.display = null;
            }
        }

        document.addEventListener("DOMContentLoaded", function(e) {
            //Parse the URL
            doughRequest = new DoughRequest().parseURL(window.location.href);

            tf.value = doughRequest.getTf();
            diameter.value = doughRequest.getDiameter();
            shape.value = doughRequest.getShape();
            length.value = doughRequest.getLength();
            width.value = doughRequest.getWidth();
            quantity.value = doughRequest.getQuantity();
            water.value = doughRequest.getWater();
            yeast_type.value = doughRequest.getYeastType();
            yeast.value = doughRequest.getYeast();
            salt.value = doughRequest.getSalt();
            sugar.value = doughRequest.getSugar();
            oil.value = doughRequest.getOil();

            if(doughRequest.getFlours().length >= 1){
                flour1.value = doughRequest.getFlours()[0].getName();
                flour1_amt.value = doughRequest.getFlours()[0].getAmount();
            }
            if(doughRequest.getFlours().length >= 2){
                flour2.value = doughRequest.getFlours()[1].getName();
                flour2_amt.value = doughRequest.getFlours()[1].getAmount();
            }
            if(doughRequest.getFlours().length >= 3){
                flour3.value = doughRequest.getFlours()[2].getName();
                flour3_amt.value = doughRequest.getFlours()[2].getAmount();
            }

            if(doughRequest.getFlours().length > 0) {
                document.getElementById("add-flour").style.display = "none"
                document.getElementById("multi-flour").style.display = null;
            }

            if(doughRequest.getImage() != null) {
                document.getElementById("upload-progress").style.display = "none";
                document.getElementById("imgurUpload").style.display = "none";
                document.getElementById("image-preview").src = doughRequest.getImage();
            }

            calc();
        });


        function upload(file) {
            document.getElementById("imgurUpload").style.display = "none";
            document.getElementById("upload-progress").style.display = "";
            /* Is the file an image? */
            if (!file || !file.type.match(/image.*/)) return;

            /* It is! */
            document.body.className = "uploading";

            /* Lets build a FormData object*/
            var fd = new FormData(); // I wrote about it: https://hacks.mozilla.org/2011/01/how-to-develop-a-html5-image-uploader/
            fd.append("image", file); // Append the file
            var xhr = new XMLHttpRequest(); // Create the XHR (Cross-Domain XHR FTW!!!) Thank you sooooo much imgur.com
            xhr.open("POST", "https://api.imgur.com/3/image.json"); // Boooom!
            xhr.onload = function() {
                // Big win!
                calc();
                document.getElementById("upload-progress").style.display = "none";
                document.getElementById("image-preview").src = JSON.parse(xhr.responseText).data.link;
                doughResult.doughRequest.setImage(JSON.parse(xhr.responseText).data.link);
                url = doughResult.doughRequest.getShareableURL(top.location.origin.toString(), top.location.pathname.toString());
                document.getElementById("url").innerHTML = "<a href='" + url + "'>" + url + "</a>";

            }
            
            xhr.setRequestHeader('Authorization', 'Client-ID 8061f70841482dc'); // Get your own key http://api.imgur.com/
            
            // Ok, I don't handle the errors. An exercise for the reader.

            /* And now, we send the formdata */
            xhr.send(fd);
        }
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133179201-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-133179201-1');
    </script>    
</body>